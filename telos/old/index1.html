
<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="nis.css"/>
    <script type="text/javascript" src="https://runeapps.org/runeappslib.js"></script>
    <script type="text/javascript" src="https://runeapps.org/alt1lib.js"></script>
    <script type="text/javascript" src="https://runeapps.org/imagedetect.js"></script>
    <script type="text/javascript" src="https://runeapps.org/imagelibs/dialog.js"></script>
	<script type="text/javascript" src="https://runeapps.org/imagelibs/chatbox.js"></script>
	<script type="text/javascript" src="https://runeapps.org/imagelibs/castlewars.js"></script>
	<script type="text/javascript">
		capturecenter={x:300,y:300};
		xpcallback=false;
		xpcountercallback=false;
		currenttooltip="";
		
		//This object is used to set the config for this app
		var exampleconfig={
			appName:"Example app",
			description:"This app is an example for other developers, this text will show up in the app list.",
			appUrl:"/apps/alt1/example/",//app startup url relative to current domain
			configUrl:"/apps/alt1/example/appconfig.jon",//link to a json file which contains this object, this link uniquely identifies your app
			defaultWidth:300,//preferred sizes, can be overwritten by alt1
			defaultHeight:300,
			minWidth:200,
			minHeight:200,
			maxWidth:1000,
			maxHeight:1000,
			
			//used to signal alt1 that this app can handle certain requests like a player lookup when the user presses alt+1 over a player name.
			//{handlerName:"player",handlerUrl:"/myUrl/?player=%s",handlerScript:"setPlayer('%s');"}
			requestHandlers:[],
			
			//will open this app when you press alt1 while hovering over drop blue partyhat etc (up to 10 currently)
			activators: ["Drop Blue partyhat", "Drop Purple partyhat","regex:^Activate (?<abil>[\w ]+)$"],

			//a comma separate list of required permissions for this app to run
			permissions:"pixel,gamestate,overlay"
		};
		// w: 7 h:10
		MinimapReader.homeportbutton = null; ImageData.fromBase64(function (i) { MinimapReader.homeportbutton = i; }, "iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAIAAAC0tAIdAAAA70lEQVQoU4WSoW4CQRRF5ydQdUgcAsEaEpIK1P4AAdUQXAXB4FuNgiCKJdUVdYsihKQG+IKmAgFyg8D0TO7mMRkamhzx3n3nzWwy694+fz62+XTy9dx6fWoMIwgZIaC16333vjr2B3OqOyCgseB6nVla64bIiEI0bnBqHitpfr6AjUEJI7WjceZterNV3yZoXOiiWVJuGqENLBS2zaoPiVQKJdS2cLV33/mfxLZOiiRDtxU2VWhXSlUjtIW36Zmt9ycIbUtswUmF5eYAmim0RKH/EjXA24IGsi0RvL9/HevvgOb/k5fF9t8FBLTROPsFtJgUMNwTN50AAAAASUVORK5CYII=");

ImageData.fromBase64(i=>MinimapReader.energies.botrun.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAJCAYAAAA2NNx1AAACLElEQVQ4T32Ry0tUURzH73qcmXtvMzDBjDWNo+M8mkkKJIg2QZsIilZhBRal+ZgayUfazGhjOQ+MNIwkqBa9zF5gPhetWoWiaJBF2qJFm/6HT79zIbGoFl/OPef3PR++53u161GT3mqDS0EnbQmTH++rWelzspi0sZR2kt6vW7Or4slHTHIxk5TsH54o49ttk4m+OM2y767SLU5/2KAoHi0t5jYZnI84WJvyW9DlrJPSUTcNfgedlfoGtCghBmTtEUhjQGfsjI2vc37qfHbLO3o6SGanSSmxBa0h5mbpgZfv4y7mm22MnHRxVi6lKiRtSOeaJFDQgkAVWK0qVXtQ56K88OOQwXjWw4fHXp6ds5HZY5Ct9aC1HtrOyqDBQouNU+V2kgEnVwSY+wO4Weo8GzJoFe9Eh4PVYYOne3Xyqra4m3xdJdpoJsjLTpPFjJOWgMOCquf+DbhZ6iVdUlPpiJsn9WU0Sp3JiIv0sQDTIxG0d4+83Evv4O0NO6laH7molC+dliTR/1SoMsgJuEeAXRImtdtL9niUN7fCfJrehgZo82M+xoeryTeFuXzQT3/CTUl+UEkl+oeKooKoN+6iS+4MXogydz/GF4EqpgVWWp30sPDcz+SdEDcbdtF9oIKOfeUUatwUpZoNoKpJztRMeZR3ajTE0is/a7NbLehvYKX1GS/rsx6WX1cwczfMi4EEQ6k4ufoY7YdrLKlvdaZmyqO86s7n6XJB/GKh/QSAKZFujscOhgAAAABJRU5ErkJggg==");
ImageData.fromBase64(i=>MinimapReader.energies.toprun.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAKCAYAAACwoK7bAAACWUlEQVQ4T12SXUhTYRjHdxvYxfIqaWfn+3ub07lJow8JvegmdEUZFQZWSIGJ0IUQFNSIgYHBxAvrouiqgiiKCCrrLiIIKcEIdRM/qjkvKjQI/j3Pa1utiz/nPed9/7/n/zzvCQCo0dL0WayXTuJXuRc/FruxMnMASx8zWJjqEuI1f+M9PsNn2fM/p7ooTPZj7esJfF88ivkPGdwe24Xjh3zsSGrwbBmGJkFTQrD1EFrjMno6bdzM70TxfUZ42MuMGnBpuhdry0doYx/OD7SiOapA18JVuY4Jy9TgO2Gc64uhsz0MSWqASoXivoKh/pTwMoNZArz66Ri+LRzEg1u7kU6oAuS5Vo0c24CmyZh6pODnrCk0eCoG01DhUFH2bCcvM5jFzMDq3H6MXE7BMWUB4XQMsi0dUd8S8l1DmFcmJJTf2ii/lHBn1IOmyrDonG0ZwuNZYVzLJsHMQP5KCqa+kZKhDIp4Os1VgaHLlEqGrkqQQg14NxzE8r16ofvZOtimQuPRkRvyYNKoGM6s4YtJBHy6mErLsahNcB1v7qpYnzHx+bWN6ScqHt7wMZZNYPaZIqDjA1uosArLUHDpTKMYzd42eqf0ghOxEOBFU6MrtNG2JYCTV4Mojv5NyO1XxjAxson+kLC40K42BV+eS+juUKhTE/GYK+BVcDzmkHy0p3UUntZjT4uCdFxFT8dWFPNBzFMRASdxoesXtkEJh3D6sIHSCwmeGKNZDRmoLFqaY9SCi/FcBI9zdXBtk0R/A11QgcD/Jucnt58d1MXIXvVtprQ2Ek3RP2AXvwFBOdopSrlbYgAAAABJRU5ErkJggg==");
ImageData.fromBase64(i=>MinimapReader.energies.botwalk.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAJCAYAAAA2NNx1AAABPElEQVQ4T52QS0vDQBSF8w9EW5e6UqGpZCEWk7bSRNOFRijiAx9ItQqCQlHc6KaUppriiChSFBciKAjizh94zJnQmNIsShcfDHfu+e6dUW7TwyB3Mwk0tSR+X6uoH1qS9skS3LkxeUc6veRxPYOXq028HS2EtWhPKL5Oj+CnVYaoOhDHRXh2KmyKo+XT2NLx7e2HtXtzAk3fw7MUf5zZ+KxtQFQsPKxo8NReURyuNorni1V/60V81bZRr5hwp4Otpfj93EFjx+gJ9oPYy8svYd7LjYd1xc6mINZm0T5d7gr0jT0FsZvFTeSVdCqFeQPFvIqncsH/50hgQCilUwGg6LYlC5dqAmJyaCCYpYMuOqWYmKUSckYGB+mknBwXjoO9zDCr246Udok7cCKbOJ2BuFewxjv2BMJgy3+g/AE1fHtiHRueRwAAAABJRU5ErkJggg==");
ImageData.fromBase64(i=>MinimapReader.energies.topwalk.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAKCAYAAACwoK7bAAAB30lEQVQ4T2WS204TURSG5x1owAOHqHVKWwotbZ1MaUsjJKLU1A5WA2oNwRCLFSFtgxgMIQESg5SCChjjjaQ18RC9MOEFjK/1O/8iM+m0F99kzd7/+vaelVEAOPhcb2B9bxcLxQWkMhlo0RDcV/rQdeGiwJpr3GOGWfa0etqExlRWmiP9LuiXzyGudmPoai887j6BdcLTjeSlTskwO5lOtx0gj71aDbNzTyQU87kQVXuktvD7PGd4VRg3NUSDqr0XNrO62cOaDrpEzJPGryfh7z+PmHk7h6iF99tzOK2v4N/PCm7diNvr7NHNAwZMB110KqMJHRFvJ/zuXoeEDAd9Dr5VH+L3xyX8OshjeyXXlg+YYwp7XAiPpKBwTpydtUlBaMgrtIrfrRk4Xr2HxuYMXhUNe/1xbszupys50AFl0DylWUq2Vmfw56SC+ofn+PT2Kd68zmNt+T5OqgURl59N4FokKNnpbErGo0UDtifoV6E0Cwl/pcbRIg4qBg5f5uR2hJ9vjaFaykqOjMaG8WW3gIQWsB10OsQM6loIP2qPENfDUhsTI+Yhd7GzOClSi9L8HcnnMnF83XkgteUhSrOUFGdvY6OQtt/JfnnKcXOOg5//Yj6Dv9/LKOXH7eyZz4f/f7KmZoAX4KUAAAAASUVORK5CYII=");
	MinimapReader.energies = {
		botrun: { x: 35, y: -29, img: null },
		toprun: { x: 35, y: -9, img: null },
		topwalk: { x: 35, y: -9, img: null },
		botwalk: { x: 35, y: -29, img: null },
	};


	function MinimapReader() {
		this.pos = null;

		this.find = function (img) {
			if (!img) { img = a1lib.bindfullrs(); }
			if (!img) { return null; }
			var homeport = a1lib.findsubimg(img, MinimapReader.homeportbutton);
			if (homeport.length == 0) { return null; }
			var botleft = { x: homeport[0].x - 17, y: homeport[0].y + 33 };

			var area = { x: homeport[0].x - 17, y: homeport[0].y - 700 + 33, w: 700, h: 700 };
			if (area.y < 0) { area.h += area.y; area.y = 0; }
			if (area.x + area.w >= img.width) { area.w = img.width - area.x - 1; }

			var topright = null;
			for (var a in MinimapReader.energies) {
				var pos = a1lib.findsubimg(img, MinimapReader.energies[a].img, null, area.x, area.y, area.w, area.h);
				if (pos.length != 0) {
					qw("found energy", a);
					topright = { x: pos[0].x + MinimapReader.energies[a].x, y: pos[0].y + MinimapReader.energies[a].y };
					break;
				}
			}
			if (!topright) { return null; }

			var w = topright.x - botleft.x;
			var h = botleft.y - topright.y
			this.pos = {
				x: botleft.x,
				y: topright.y,
				w: w,
				h: h,
				centerx: w / 2,
				centery: h / 2,
			};
			return this.pos;
		}

		this.readCompass=function(img) {
			if (!this.pos) { return null; }
			var buf;
			if (img) { buf = img.toData(this.pos.x, this.pos.y, 40, 40); }
			else { buf = a1lib.getregion(this.pos.x, this.pos.y, 40, 40); }

			var r = 11;
			var buf2 = buf.clone(new Rect(0, 0, buf.width, buf.height));
			var centerx = 22;
			var centery = 22;

			var sx1 = 0, sy1 = 0, m1 = 0;
			var sx2 = 0, sy2 = 0, m2 = 0;
			for (var x = round(centerx) - r; x <= round(centerx) + r; x++) {
				for (var y = round(centery) - r; y <= round(centery) + r; y++) {
					var i = 4 * x + 4 * buf.width * y;
					var dx = x - centerx;
					var dy = y - centery;
					if (dx * dx + dy * dy > r * r) { buf.data[i] = buf.data[i + 1] = buf.data[i + 2] = 0; continue; }

					var rating1 = buf.data[i] - buf.data[i + 1];
					sx1 += dx * rating1;
					sy1 += dy * rating1;
					m1 += rating1;
					var rating2 = Math.max(0, buf.data[i] + buf.data[i + 1] + buf.data[i + 2] - 300);
					sx2 += dx * rating2;
					sy2 += dy * rating2;
					m2 += rating2;
					if (isNaN(m2)) { debugger; }
					if (isNaN(m1)) { debugger; }

					buf.data[i] = buf.data[i + 1] = buf.data[i + 2] = rating1;
					buf2.data[i] = buf2.data[i + 1] = buf2.data[i + 2] = rating2;
				}
			}
			if (m1 == 0 || m2 == 0) { return null; }

			var mx1 = sx1 / m1;
			var my1 = sy1 / m1;
			var mx2 = sx2 / m2;
			var my2 = sy2 / m2;

			var dir = Math.atan2((my2 - my1), (mx2 - mx1));
			dir += -1 / 180 * Math.PI;
			dir = (Math.PI + dir) % (Math.PI * 2);
			return dir;
		}

		this.readEnergy = function (img) {
			if (!this.pos) { return null; }
			if (!img) { img = a1lib.bindregion(this.pos.x + this.pos.w - 50, this.pos.y + 5, 50, 40); }
			var str = alt1.bindReadColorString(img.handle, "chat", a1lib.mixcolor(255, 255, 255), this.pos.x + this.pos.w - 27 - img.x, this.pos.y + 23 - img.y);
			var m = str.match(/(\d{1,3})%/);
			message("bind region x: " + (this.pos.x + this.pos.w - 50) + " y: " + (this.pos.y + 5));
			message("x: " + (this.pos.x + this.pos.w - 27 - img.x) + " y: " + (this.pos.x + this.pos.w - 27 - img.x, this.pos.y + 23 - img.y));
			if (!m) { return null; }
			return +m[1];
		}
	}
		
		
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza0 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAUAAAAICAYAAAAx8TU7AAAAs0lEQVQYVwGoAFf/AS4kJf+am5sA+vr6ACsrKwBfX18AAa2opf/d3N8AgICAAENDRQBdX14AAd7W0/8vLy8ACg0OAAwLDQDa2toAAf799/8MBgkAFBYVAP//AACsrKwAAf799/8JBQkAFxcUAAAAAQCurq4AAfXw7P8PEBQAISAcAPz8/ADMzMwAAbqxtP+NjY0A2NjYAD4+PgBaWloAAUY7P/+UlpUA7OrrABUXFgBdW1wAeIlAv7sVC+oAAAAASUVORK5CYII='
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza1 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAUAAAAICAYAAAAx8TU7AAAAs0lEQVQYVwGoAFf/ATUwLf9HR0YAUVFSAJiYlwC2trgAAVJNSv87OzoAQ0NEAHd3dgDT09UAARkSD/8EBAIAqaiqAIWGgwDJycwAASYfGf/4+PkAq6mpAIKCggDY2NgAASYdF//29vYAr6+uAIODgwDHyMgAAREIA/8aHBsAnpydAIaIhwDQztAAASkhH//2+fgAqKWmAH2AfwDd2tsAAUtFRf96enoAMTExANra2gDHx8cAP41EfqSdRxYAAAAASUVORK5CYII='
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza2 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAUAAAAICAYAAAAx8TU7AAAArElEQVQYVyXIzQoBUQCA0e+uLkPTRQkbZeFxNG9AfrYs7O0ow6SmhpUX8BNvYTFlI5NXmIUUzRRTroWzPGI0HOhGw8I0Te6PJ+12F9HvNPVus+XxinE9j8s1QNRKRR3HMUopWr0uSZL8E8DIZtgfD1iWhahXy/r9/mDbU4LbjfFkjqjklV6tlvi+j+MsUIUcYu0udRiGzJw5MiUx0gbi+/nq8+lEFEVIKZnObH4LyEMWtrr71QAAAABJRU5ErkJggg=='
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza3 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAUAAAAICAYAAAAx8TU7AAAAs0lEQVQYVwGoAFf/AX51dv9NTU0AAQAAAJ6engC/v78AAVdRUf/BwcEAEBAQALy6uABiYmIAASEcGf/x7+8AFhUVAKippgBsbGwAAT86Nv9QTkwAMTExANHRzwB4eH4AATEsJv8nJycAHBwcAFpaWgBnZ2cAAR8aFv8DAwMA8PHxAHFwcADz8/MAATYtMP/n5+cAAAAAAKampgC3t7cAAc7FyP/7+foAEhQTAKelpgCGiYcAREc9IOocl/kAAAAASUVORK5CYII='
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza4 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAcAAAAKCAYAAAB4zEQNAAABEklEQVQoUx3OT0vCYADA4d/LdP6ZNCNNg6WlDKxD9+qSQiyokZBXL0J1kKJLafQBDCTqlJDn/EiyQ4foAyTZwEW9ewOfT/CIUi6rNASJlMF08oWeiIEMkVIiKgVL+b6PpmlEIxFeRyNCKWk2m4hiLqPieoxf+cf56RmVzQ3SCyYnjQYiv5RWuhahZJe5697y8PRI9/oG13URa9aK0qNRXoZD7ns9koZBt9OhVqsiykVLtVqteaDf7+M4Du12G/foEGHlMmo8HuN5HkEQYJomtm0zGDwjVvNZZcQTvL1/YKaSbO/ucHVxSb1+jCgsZxShwlw08aff7NWq87VzsI/YKq+r2WxGEPwgQ0lM15EyZDL55B/7al7YAg3QxQAAAABJRU5ErkJggg=='
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza5 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAcAAAAKCAYAAAB4zEQNAAABC0lEQVQoUx3PvU7CYBhA4fNGaSKtYBRp1bL4k5jogDCiUSfuSb0DggwaGI3oKImoI3dAQlwU3XGVIK3a8rWfkQs4yXNkM2drz/MxDINEYhYVhljWHGE4QZwFU38MBnS7XVQc0X99p1KpEAQBsuXa+vqmydFxmXTKJAxChBlSaQvJOUu63b6ntH/AciaDIQlEZtA6Qlx7Ubdad4y9ESvOGvWLBk8Pj4gIsuFmdRxrhsNPLGuel/4b+cIeURQh605WKxUxUROSZpKr2yaVapXnXg8pbu/qf5nnedPislEnXyygoxgplw71ea3Gt++TNE1Ozk7pdDrYto3s5Fzt//4wHn1NPwMVk1t1UErxB6ExdfiibdCgAAAAAElFTkSuQmCC'
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza6 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAcAAAAKCAYAAAB4zEQNAAABFklEQVQoUxXNwUrCYADA8f9H5uaaQ3QuNLMMO3uxgx2kmwh6dycfwQcQvEVC5ckEX8EHWLc8Chv4CCKhXiKrg0wb44t+L/AT1zlT7nY7EkYC398Ti2mEYUgQhIiLU1PG43GazSbtdpvtdovjvDKZTBB5y5SNRgPbtmm1bD4+t2hqlKiiIIrZjByPx/T7D8xmMwqFAt8/X+j6CeLSSsvFesV9r0etVkNRjxkMBkynb4j8mSWXywX1eh3X87itVBiNRpTLN4jzbFrO53OKxSJHkQhaTON9vUL7P1NGQr4Mh7iui+M4lEolOp0O1bsq4iqTk5Zl8fz4xOFwwDAMut0unuchCpYpf4OAuK6z2WxQVJW975NMpvgDzvNjNaWcZ8YAAAAASUVORK5CYII='
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza7 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAcAAAAKCAYAAAB4zEQNAAABCUlEQVQoUx2PTUoCcRxA38+Zf2ZJKo6NNk4flFHgUlxJqYvOYB8XKDtCJFFItxDaCG08gotgll6jhbNQcNJmkH9Mb/vgwZNj29amaRJFESKCiEGMXkfIfmFXj0YjgiAguZX6l7Vajav2JVK28lopk+B3xXw2p9Vu8fzU46LZRMr5jE6nUwTLJXH+tf+G9+Ux/BwiZwdF/bNaIaKpVE4ZfAyonldRqU3E3bO0IQk0ax7uu0TrkJfeO65rI07R0qZpkECYTCY0Gg2mvk/SUMiR4+p44+76hnq9Tue2Qy6TI7uzjRwWSjr+Go/HPHa7eJ6H4zgsFjPkpGRrlTAIw5DvqY+Vy7KhFEop/gCWYFT5AVgE4wAAAABJRU5ErkJggg=='
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza8 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAcAAAAKCAYAAAB4zEQNAAABI0lEQVQoUwXBvUpCYQCA4ffTOmZGokbkb6GJQT84Si6BEYhEDrnoFUTHHE6lx+geaogmoakaopDqBvQCHCKptgiqoaSUPArC1/OIkGtCWm2jtH/bDCtDmExgHbPR7xoIn9MhU+spyiWd988PvF4fW+o2T49NRNDvlo1Gg0QiwcPDI5nMJhvpNKpaQAQ9U7Jer5PL5Wi+PFMqFnG5nKhqHjHr88j5pUUOywd8/7QYDAbkCzu0vr4RoYBHanu7zASmOb+8QNM0KmcVbq6uEcnVFXl0dMxyPI5hGESjUe7ub4lE5hAba0l5cnJKLBbDrJgJh8NUq1XsDjvCPe6QmrZPNpvl7e0VRVHQdZ1avYZYCPilYfRodzr89XqMWCx0+328U5P8AxIfZgMK2/D3AAAAAElFTkSuQmCC'
		);
		ImageData.fromBase64(function (i) { CastlewarsReader.pizza9 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAcAAAAKCAYAAAB4zEQNAAABC0lEQVQoU2PUlpb8//fvX4Y/jP8Z2JlYGEDg+59fDExMTAyMKpKi/z19/RjSsnMZPn38yMDIwMiQm5bM8PHjBwZGYw3V/+t37GZwdbRjePDkGUNpWRmDoqIiQ2t1JQNjXFjwf5AuRydnBlkRQQYmJkaG09duMchLSzIwOlqY/F+/fTeDlqYGAxfjPwYrWzuGhSvXMDAzQ+0MjYphSMnKYXj+5DHD1cuXwPYzMjJCHARy4advPxjef/nGYGZmytDa2sbg4OQEkeTnFwC7DgQmzZzDsGnDeoZFS5dBJJu7ehhk5eQZ+AUEGLZv3sTQ1NLKwMPJjjD27aevDD///GH4/+8/Aw8XB4MYDw8DABSgXMRBlsIgAAAAAElFTkSuQmCC'
		);
		
		
		ImageData.fromBase64(function (i) { CastlewarsReader.phase1 = i }, 
			'iVBORw0KGgoAAAANSUhEUgAAAAcAAAAKCAYAAAB4zEQNAAAApUlEQVQoU2NUlpX8z/j3D8N/ZhYGEACxYYBRRUr0Pz+/AIOnrx9DeHQsQ3dbM8Oxw4fAisGSOnr6DJY2dgzu3r4MlZUVDBdPn2DgYmeDSIKM+fn7D8PiVWsZOjs7MSVBChauWMPQ1t7OcP7UcVSdNJAEuba0qpZBW0+P4d7dewzHjhximNDZxsAICgQGFhaGX1++MLz58p3h58+fDKzMzAycXFwMADgnUh/kIfL2AAAAAElFTkSuQmCC'
		);
		//reference the appconfig.json file as config, this file can also be referenced in an alt1 link in any browser
		//clicking this link in any browser will start alt1 and show an add app dialog
		//<a href="alt1:addapp:http://runeapps.org/apps/alt1/example/appconfig.json">Add example app</a>
		//only supported in alt1 1.1+
		if(window.alt1 && alt1.versionint>1001000){alt1.identifyAppUrl("appconfig.json");}
		
		//i'm crippled without this function
		function elid(id){return document.getElementById(id);}
		
		//this function will be called when the user presses alt1 over anything
		function alt1onrightclick(obj){
			message("Alt+1 ("+obj.x+":"+obj.y+") - \""+obj.text+"\"");
			capturecenter={x:obj.x,y:obj.y};
			docapture();
		}
		
		//captures the area around the last alt+1 press and displays it on a canvas
		function docapture(){
			var size,rawcapture,image,ctx,cnv,capturex,capturey,color,pixelindex,red,green,blue;
			cnv=elid("capturecnv");
			ctx=cnv.getContext("2d");
			
			//get the location for capture
			size=cnv.getBoundingClientRect();
			capturex=capturecenter.x-Math.round(size.width/2);
			capturey=capturecenter.y-Math.round(size.height/2);
			
			//do capture
			rawcapture=a1lib.getregion(capturex,capturey,size.width,size.height);
			//rawcapture is an imageBuffer object 
			//it has width, height and a Uint8Array called data, this array holds all pixel data in one dimension
			
			if(!rawcapture){//check if capture succeeded
				message("Image capture failed");
				return;}
			
			//calculate the index of the pixel underneath the mouse
			//multiply the x-coord by 4 as every pixel has 4 components (red,green,blue,alpha)
			pixelindex=(capturecenter.x-capturex)*4;
			//multiply the y-coord by 4*width
			pixelindex+=(capturecenter.y-capturey)*4*rawcapture.width;
			
			red=rawcapture.data[pixelindex+0]//index+0 is red
			green=rawcapture.data[pixelindex+1]//index+1 is green
			blue=rawcapture.data[pixelindex+2]//index+2 is blue
			//index+3 is alpha, we rarely need that
			
			//display the color in our output div
			elid("coloroutput").style.background="rgb("+red+","+green+","+blue+")";
			elid("coloroutput").innerHTML="rgb:<br>"+red+" - "+green+" - "+blue;
			
			//to actually draw the buffer we sadly need to convert it to an image as it's not a real imageBuffer object (otherwise we could use the ctx.putImageData function)
			//this function draw the buffer pixel by pixel and thus is quite slow on big images
			image=rawcapture.toImage();
			
			//reset the canvas and draw the image
			cnv.width=image.width;
			cnv.height=image.height;
			ctx.drawImage(image,0,0);
		}
		function drawImg(buf) {
			var size,rawcapture,image,ctx,cnv,capturex,capturey,color,pixelindex,red,green,blue;
			cnv=elid("capturecnv");
			ctx=cnv.getContext("2d");
			image=buf.toImage();
			
			//reset the canvas and draw the image
			cnv.width=image.width;
			cnv.height=image.height;
			ctx.drawImage(image,0, 0);
		}
		
		function TelosReader() {
			var me = this;
			this.readPhase = function () {
				// TODO 
				// Make coordinates independent of layout
				var x = 757;
				var y = 47;
				var w = 100;
				var h = 40;
				
				var img = a1lib.bindregion(x, y, w, h); 
				//drawImg(a1lib.getregion(x, y, w, h)); // Debug info
				
				// Find the string in the region
				var str = alt1.bindReadColorString(img.handle, "chat", a1lib.mixcolor(255, 255, 255), 23, 18);
				var m = str.match(/Phase: (\d{1})/);
				if (!m) { 
					//message("no numb found in " + str);
					return null; 
				}
				return +m[1];
			}
			this.readEnrage = function () {
				// TODO 
				// Make coordinates independent of layout
				var x = 1030;
				var y = 47;
				var w = 100;
				var h = 40;
				
				var img = a1lib.bindregion(x, y, w, h); 
				drawImg(a1lib.getregion(x, y, w, h)); // Debug info
				
				// Find the string in the region
				var str = alt1.bindReadColorString(img.handle, "chat", a1lib.mixcolor(255, 255, 255), 23, 18);
				var m = str.match(/Enrage: (\d{1,4})%/);
				if (!m) { 
					//message("no numb found in " + str);
					return null; 
				}
				return +m[1];
			}
		}
		
		function CastlewarsReader() {
			var me = this;

			this.read = function () {
				var img = a1lib.bindfullrs();
				if (!img) { return false; }
				var r = { ingame: false, inlobby: false, timeend: 0, timestart: 0, respawnroom: 0 };
		
				//find game timer
				//var phase = a1lib.findsubimg(img, CastlewarsReader.phase1);
				// 758/55
				//message("length: " + phase.length);
				/*
				for (var i = 0; i < phase.length; i++) {
					message("x: " + phase[i].x + " y: " + phase[i].y);
				}
				*/
				/* phase values 
				var x = 757;
				var y = 47;
				var w = 100;
				var h = 40;
				*/
				
				
				/* enrage values */
				var x = 1030;
				var y = 47;
				var w = 100;
				var h = 40;
				
				img = a1lib.bindregion(x, y, w, h); 
				//drawImg(a1lib.getregion(x, y, w, h));
				var str = alt1.bindReadColorString(img.handle, "chat", a1lib.mixcolor(255, 255, 255), 23, 18);
				message("str: " + str);
				var m = str.match(/Phase: (\d{1,3})/);
				if (!m) { 
					message("no numb found" + str);
					return null; 
				}
				message("found: " + +m[1]);
				/*
				var buf;
				for (var i = 0; i < 10; i++) {
					buf = CastlewarsReader["pizza" + i];
					var subimg = a1lib.findsubimg(img, buf);
					if (subimg.length != 0) {
						message("found: " + i + " at x: " + subimg[0].x + " y: " + subimg[0].y + " with length: " + subimg.length);

					}
					var size,rawcapture,image,ctx,cnv,capturex,capturey,color,pixelindex,red,green,blue;
					cnv=elid("capturecnv");
					ctx=cnv.getContext("2d");
					image=buf.toImage();
					
					//reset the canvas and draw the image
					//cnv.width=image.width;
					//cnv.height=image.height;
					ctx.drawImage(image,0 + i * 7,0);
				}
				*/
				
				
				/*
				if (timeuntilpos.length != 0) {
					var size,rawcapture,image,ctx,cnv,capturex,capturey,color,pixelindex,red,green,blue;
					cnv=elid("capturecnv");
					ctx=cnv.getContext("2d");
					image=buf.toImage();
			
					//reset the canvas and draw the image
					cnv.width=image.width;
					cnv.height=image.height;
					ctx.drawImage(image,0,0);
					
					
				} else message("not found");
				*/
				/*
				if (timeuntilpos.length != 0) {
					r.inlobby = true;
						//read timer
					var timer = "";
					var buf = img.toData(timeuntilpos[0].x + 189, timeuntilpos[0].y - 4, 30, 10);
					for (dx = 0; dx < 20; dx++) {
						for (var i = 0; i < CastlewarsReader.timelobbyimgs.buffers.length; i++) {
							var numbuf = CastlewarsReader.timelobbyimgs.buffers[i];
							var match = a1lib.simplecompare(buf, numbuf, dx, 0) !== false;
							if (match) {
								dx += numbuf.width - 1;
								timer += "" + i;
								break;
							}
						}
					}
					r.timestart = +timer;
				}		
				*/				
				return r;
			}
		}
		var phasereader = new CastlewarsReader();
		var runreader= new MinimapReader();
		var telosreader = new TelosReader();
		function toggletooltip(){
			//phasereader.read();
			//runreader.find();
			//message("this.pos.x + this.pos.w - 27 - img.x, this.pos.y + 23 - img.y ---- pos.x: " + runreader.pos.x + " pos.w: " + runreader.pos.w); 
			//message(runreader.readEnergy());
			
			setInterval(function () {
				message("phase: " + telosreader.readPhase() + " enrage: " + telosreader.readEnrage());
			}, 1000);
			message("done");
		}
		
		
		var reader = new ChatBoxReader();

		function toggletooltip2(){
			if (!(img = a1lib.bindfullrs())) { 
				message("Need pixel permission.") 
			} else message("------------");
			reader.find();
			reader.readargs = { colors: reader.defaultcolors, backwards: true };
			var opts = reader.read();
			message("length: " + opts.length);
			for (var a = 0; a < opts.length; a++) { 
				message("msg: " + opts[a].text); 
			}
		}
		
		function xprise(str){
			message("Xp rise: \""+str+"\"");
		}
		
		function xpcounter(obj) {
			var a,str;
			str = "";
			for (a in obj.counters) {
				str += obj.counters[a].skill + " " + obj.counters[a].text + " - ";
			}
			message("Xp: " + str);
		}
		
		function message(str){
			elid("eventlog").innerHTML=str+"\n"+elid("eventlog").innerHTML;
		}
		
		function start(){
			if(window.alt1){
				message("Page loaded, alt1 recognised.");
				message("Alt1 version: "+alt1.version);
				message("Press alt-1 to capture.");
				
				if(alt1.permissionInstalled) {
					console.log(JSON.parse(alt1.openInfo));
				}
				//dump all events onto the console (right-click the settings spanner to view)
				for (var a in alt1.events) {
					alt1.events[a].push(function (e) { console.log(e); });
					//message(JSON.stringify(alt1));
				}
			}
			else{
				message("Page loaded, alt1 not recognised.");
			}

		}
	</script>
	<style type="text/css">
		#eventlog{position:absolute; top:210px; right:5px; bottom:5px; left:5px; white-space:pre; background:rgba(0,0,0,0.5); outline:1px solid gray; padding:5px; font-family:monospace; overflow-x:hidden; overflow-y:auto;}
		#capturecnv{position:absolute; top:5px; left:5px; height:200px; width:calc(100% - 130px); background:url('transblocks.png'); outline:1px solid gray;}
		#xpdroptoggle{position:absolute; top:0px; right:0px; width:90px;}
		#docapturebutton{position:absolute; top:40px; right:0px; width:90px;}
		#tooltipbutton{position:absolute; top:80px; right:0px; width:90px;}
		#xpcountertoggle{position:absolute; top:120px; right:0px; width:90px;}
		#coloroutput{position:absolute; top:165px; height:40px; width:115px; right:5px; outline:1px solid gray; color:white; text-shadow:1px 1px 0px black;}
	</style>
</head>
<body class="nis" onload="start();">
	<canvas id="capturecnv"></canvas>
	<div id="docapturebutton" class="nisbutton" onclick="docapture();">Capture</div>
	<div id="tooltipbutton" class="nisbutton" onclick="toggletooltip();">Tooltip</div>
	<div id="coloroutput">Press alt+1 to grab a color</div>
	<div id="eventlog" class="nistext"></div>
</body>











